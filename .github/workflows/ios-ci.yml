name: iOS CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ios-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Select available iPhone simulator
        id: simulator
        shell: bash
        run: |
          set -euo pipefail

          DEVICE_NAME=$(xcrun simctl list devices available | awk -F '[()]' '/iPhone/ {gsub(/^ +| +$/, "", $1); print $1; exit}')
          if [[ -z "${DEVICE_NAME}" ]]; then
            echo "No available iPhone simulator found."
            exit 1
          fi

          echo "Using simulator: ${DEVICE_NAME}"
          echo "name=${DEVICE_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Build and run tests
        shell: bash
        run: |
          set -euo pipefail

          xcodebuild test \
            -project StreakVoyage.xcodeproj \
            -scheme StreakVoyage \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.name }}" \
            -skip-testing:StreakVoyageUITests \
            CODE_SIGNING_ALLOWED=NO
