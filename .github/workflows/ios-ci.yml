name: iOS CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  checks: write

concurrency:
  group: ios-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  IOS_SIMULATOR_DESTINATION: platform=iOS Simulator,name=iPhone 17 Pro,OS=latest,arch=arm64

jobs:
  test-shards:
    name: Unit Tests (${{ matrix.shard.name }})
    runs-on: macos-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard:
          - name: Core Workout and Store
            test_group: core_tests
          - name: Home Progress Rules
            test_group: home_tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run shard with xcodebuild test
        shell: bash
        run: |
          set -euo pipefail

          UNIT_TEST_RESULT_BUNDLE_PATH="${RUNNER_TEMP}/TestResults-${{ matrix.shard.test_group }}.xcresult"
          echo "UNIT_TEST_RESULT_BUNDLE_PATH=${UNIT_TEST_RESULT_BUNDLE_PATH}" >> "${GITHUB_ENV}"

          test_filters=()
          if [[ "${{ matrix.shard.test_group }}" == "core_tests" ]]; then
            test_filters+=(
              -only-testing:StreakVoyageTests/WorkoutSessionViewModelTests
              -only-testing:StreakVoyageTests/HomeProgressStoreTests
              -only-testing:StreakVoyageTests/StreakVoyageTests
            )
          else
            test_filters+=(-only-testing:StreakVoyageTests/HomeDashboardViewModelTests)
          fi

          rm -rf "${UNIT_TEST_RESULT_BUNDLE_PATH}"

          # For our current suite sizes, xcodebuild's internal parallel test workers
          # add startup overhead that is larger than the gain from concurrency.
          xcodebuild test \
            -project StreakVoyage.xcodeproj \
            -scheme StreakVoyage \
            -destination "${IOS_SIMULATOR_DESTINATION}" \
            -parallel-testing-enabled NO \
            -enableCodeCoverage YES \
            -skip-testing:StreakVoyageUITests \
            -resultBundlePath "${UNIT_TEST_RESULT_BUNDLE_PATH}" \
            "${test_filters[@]}" \
            CODE_SIGNING_ALLOWED=NO

      - name: Detect unit test result bundle
        if: always()
        id: detect-unit-result
        shell: bash
        run: |
          set -euo pipefail

          if [[ -d "${UNIT_TEST_RESULT_BUNDLE_PATH}" ]]; then
            echo "found=true" >> "${GITHUB_OUTPUT}"
            echo "path=${UNIT_TEST_RESULT_BUNDLE_PATH}" >> "${GITHUB_OUTPUT}"
          else
            echo "found=false" >> "${GITHUB_OUTPUT}"
            echo "No unit test result bundle found at ${UNIT_TEST_RESULT_BUNDLE_PATH}"
          fi

      - name: Publish unit test summary
        if: always() && steps.detect-unit-result.outputs.found == 'true'
        uses: kishikawakatsumi/xcresulttool@v1
        with:
          path: ${{ steps.detect-unit-result.outputs.path }}
          title: Unit Tests (${{ matrix.shard.name }})
          show-passed-tests: false
          upload-bundles: failure

      - name: Upload unit coverage to Codecov
        if: always() && steps.detect-unit-result.outputs.found == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) && (env.CODECOV_TOKEN != '' || github.event.repository.private == false)
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        uses: codecov/codecov-action@v5
        with:
          directory: ${{ runner.temp }}
          plugins: xcode
          swift_project: StreakVoyage
          flags: ios-unit,${{ matrix.shard.test_group }}
          name: ios-unit-${{ matrix.shard.test_group }}
          token: ${{ env.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

  ui-tests-main:
    name: UI Tests (main only)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run UI tests
        shell: bash
        run: |
          set -euo pipefail

          UI_TEST_RESULT_BUNDLE_PATH="${RUNNER_TEMP}/TestResults-ui-tests-main.xcresult"
          echo "UI_TEST_RESULT_BUNDLE_PATH=${UI_TEST_RESULT_BUNDLE_PATH}" >> "${GITHUB_ENV}"

          rm -rf "${UI_TEST_RESULT_BUNDLE_PATH}"

          xcodebuild test \
            -project StreakVoyage.xcodeproj \
            -scheme StreakVoyage \
            -destination "${IOS_SIMULATOR_DESTINATION}" \
            -only-testing:StreakVoyageUITests \
            -skip-testing:StreakVoyageTests \
            -parallel-testing-enabled NO \
            -resultBundlePath "${UI_TEST_RESULT_BUNDLE_PATH}" \
            CODE_SIGNING_ALLOWED=NO

      - name: Detect UI test result bundle
        if: always()
        id: detect-ui-result
        shell: bash
        run: |
          set -euo pipefail

          if [[ -d "${UI_TEST_RESULT_BUNDLE_PATH}" ]]; then
            echo "found=true" >> "${GITHUB_OUTPUT}"
            echo "path=${UI_TEST_RESULT_BUNDLE_PATH}" >> "${GITHUB_OUTPUT}"
          else
            echo "found=false" >> "${GITHUB_OUTPUT}"
            echo "No UI test result bundle found at ${UI_TEST_RESULT_BUNDLE_PATH}"
          fi

      - name: Publish UI test summary
        if: always() && steps.detect-ui-result.outputs.found == 'true'
        uses: kishikawakatsumi/xcresulttool@v1
        with:
          path: ${{ steps.detect-ui-result.outputs.path }}
          title: UI Tests (main only)
          show-passed-tests: false
          upload-bundles: failure
