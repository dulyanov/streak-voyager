name: iOS CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ios-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  IOS_SIMULATOR_DESTINATION: platform=iOS Simulator,name=iPhone 17 Pro,OS=latest

jobs:
  build-for-testing:
    name: Build for Testing
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build unit-test products once
        shell: bash
        run: |
          set -euo pipefail

          derived_data_path="${RUNNER_TEMP}/DerivedData"

          xcodebuild build-for-testing \
            -project StreakVoyage.xcodeproj \
            -scheme StreakVoyage \
            -destination "${IOS_SIMULATOR_DESTINATION}" \
            -derivedDataPath "${derived_data_path}" \
            -skip-testing:StreakVoyageUITests \
            -only-testing:StreakVoyageTests/WorkoutSessionViewModelTests \
            -only-testing:StreakVoyageTests/HomeProgressStoreTests \
            -only-testing:StreakVoyageTests/StreakVoyageTests \
            -only-testing:StreakVoyageTests/HomeDashboardViewModelTests \
            -parallel-testing-enabled YES \
            -maximum-parallel-testing-workers 4 \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload build-for-testing products
        uses: actions/upload-artifact@v4
        with:
          name: build-for-testing-products
          path: ${{ runner.temp }}/DerivedData/Build/Products
          if-no-files-found: error
          retention-days: 1

  test-shards:
    name: Unit Tests (${{ matrix.shard.name }})
    needs: build-for-testing
    runs-on: macos-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard:
          - name: Core Workout and Store
            test_group: core_tests
          - name: Home Progress Rules
            test_group: home_tests

    steps:
      - name: Download build-for-testing products
        uses: actions/download-artifact@v4
        with:
          name: build-for-testing-products
          path: ${{ runner.temp }}/DerivedData/Build/Products

      - name: Run shard with test-without-building
        shell: bash
        run: |
          set -euo pipefail

          xctestrun_path=$(find "${RUNNER_TEMP}/DerivedData/Build/Products" -name "*.xctestrun" -print -quit)
          if [[ -z "${xctestrun_path}" ]]; then
            echo "No .xctestrun file found in downloaded build products."
            exit 1
          fi

          test_filters=()
          if [[ "${{ matrix.shard.test_group }}" == "core_tests" ]]; then
            test_filters+=(
              -only-testing:StreakVoyageTests/WorkoutSessionViewModelTests
              -only-testing:StreakVoyageTests/HomeProgressStoreTests
              -only-testing:StreakVoyageTests/StreakVoyageTests
            )
          else
            test_filters+=(-only-testing:StreakVoyageTests/HomeDashboardViewModelTests)
          fi

          xcodebuild test-without-building \
            -xctestrun "${xctestrun_path}" \
            -destination "${IOS_SIMULATOR_DESTINATION}" \
            -parallel-testing-enabled YES \
            -maximum-parallel-testing-workers 4 \
            "${test_filters[@]}" \
            CODE_SIGNING_ALLOWED=NO
